<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h4 class="fw-bold mb-1">Marketing & Promotions</h4>
    <p class="text-muted mb-0">Gérez vos codes promo et campagnes</p>
  </div>
  <button class="btn btn-primary" (click)="showCreateForm.set(true)">
    <i class="bi bi-plus-lg me-2"></i>Nouveau code promo
  </button>
</div>

<!-- Create form -->
@if (showCreateForm()) {
  <div class="table-card mb-4">
    <div class="card-header"><h6 class="fw-bold mb-0">Nouveau code promo</h6></div>
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small fw-medium">Code</label>
          <input type="text" class="form-control" [(ngModel)]="newPromo.code" placeholder="ex: WELCOME20" />
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-medium">Titre</label>
          <input type="text" class="form-control" [(ngModel)]="newPromo.title" placeholder="Nom de la promo" />
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Type</label>
          <select class="form-select" [(ngModel)]="newPromo.discountType">
            <option value="Percentage">Pourcentage</option>
            <option value="Fixed">Montant fixe</option>
            <option value="FreeDelivery">Livraison gratuite</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Valeur</label>
          <input type="number" class="form-control" [(ngModel)]="newPromo.discountValue" />
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Module</label>
          <select class="form-select" [(ngModel)]="newPromo.applicableModule">
            <option value="All">Tous</option>
            <option value="Restaurant">Restaurant</option>
            <option value="Service">Service</option>
            <option value="Grocery">Courses</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Commande min (MAD)</label>
          <input type="number" class="form-control" [(ngModel)]="newPromo.minOrderAmount" />
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Max réduction</label>
          <input type="number" class="form-control" [(ngModel)]="newPromo.maxDiscount" />
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-medium">Max utilisations</label>
          <input type="number" class="form-control" [(ngModel)]="newPromo.maxUsages" />
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-medium">Date début</label>
          <input type="date" class="form-control" [(ngModel)]="newPromo.startDate" />
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-medium">Date fin</label>
          <input type="date" class="form-control" [(ngModel)]="newPromo.endDate" />
        </div>
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" [(ngModel)]="newPromo.freeDelivery" id="freeDeliv">
            <label class="form-check-label" for="freeDeliv">Livraison gratuite incluse</label>
          </div>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" (click)="createPromo()"><i class="bi bi-check-lg me-1"></i>Créer</button>
          <button class="btn btn-light" (click)="showCreateForm.set(false)">Annuler</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Table -->
<div class="table-card">
  <div class="card-header"><h6 class="fw-bold mb-0">Codes promo</h6></div>
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead>
        <tr><th>Code</th><th>Titre</th><th>Type</th><th>Valeur</th><th>Module</th><th>Utilisations</th><th>Période</th><th>Statut</th><th class="text-end">Actions</th></tr>
      </thead>
      <tbody>
        @for (p of promos(); track p.id) {
          <tr>
            <td><span class="fw-bold font-monospace text-primary">{{ p.code }}</span></td>
            <td>{{ p.title }}</td>
            <td><span class="badge bg-light text-dark">{{ p.discountType }}</span></td>
            <td class="fw-medium">
              @if (p.discountType === 'Percentage') { {{ p.discountValue }}% }
              @else if (p.discountType === 'Fixed') { {{ p.discountValue }} MAD }
              @else { Gratuite }
            </td>
            <td><span class="badge bg-info-subtle text-info">{{ p.applicableModule }}</span></td>
            <td>{{ p.usedCount }} / {{ p.maxUsages }}</td>
            <td class="small text-muted">{{ p.startDate | date:'dd/MM' }} → {{ p.endDate | date:'dd/MM' }}</td>
            <td>
              @if (p.isActive) {
                <span class="badge-status badge-success">Actif</span>
              } @else {
                <span class="badge-status" style="background:#f1f5f9;color:#64748b">Expiré</span>
              }
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-danger" (click)="togglePromo(p)">
                @if (p.isActive) { <i class="bi bi-pause-fill"></i> } @else { <i class="bi bi-play-fill"></i> }
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<app-confirm-modal [show]="showConfirm()" [title]="confirmTitle()" [message]="confirmMessage()"
  [confirmText]="confirmText()" (confirmed)="onConfirm()" (cancelled)="onCancel()" />
