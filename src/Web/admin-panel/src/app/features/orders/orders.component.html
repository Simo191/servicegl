<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h4 class="fw-bold mb-1">Gestion des Commandes</h4>
    <p class="text-muted mb-0">Toutes les commandes de la plateforme</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <div class="btn-group btn-group-sm" role="group">
      <button class="btn" [class]="viewMode === 'list' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'list'" title="Vue liste">
        <i class="bi bi-list-ul"></i>
      </button>
      <button class="btn" [class]="viewMode === 'card' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'card'" title="Vue cartes">
        <i class="bi bi-grid-3x3-gap"></i>
      </button>
    </div>
    <button class="btn btn-outline-primary btn-sm" (click)="exportOrders()"><i class="bi bi-download me-2"></i>Exporter</button>
  </div>
</div>

<!-- Type Tabs -->
<ul class="nav nav-pills mb-4 gap-2">
  @for (tab of tabs; track tab.value) {
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedType === tab.value" (click)="selectType(tab.value)" style="cursor:pointer">
        <i class="bi me-1" [class]="tab.icon"></i> {{ tab.label }}
      </a>
    </li>
  }
</ul>

<div class="table-card">
  <div class="card-header">
    <div class="d-flex gap-2 flex-wrap">
      <div class="input-group" style="max-width:260px">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="N¬∞ commande, client..." [(ngModel)]="search" (input)="onSearch()" />
      </div>
      <select class="form-select" style="width:auto" [(ngModel)]="statusFilter" (change)="loadOrders()">
        <option value="">Tous les statuts</option>
        <option value="Pending">En attente</option>
        <option value="Confirmed">Confirm√©e</option>
        <option value="Preparing">En pr√©paration</option>
        <option value="InTransit">En route</option>
        <option value="Delivered">Livr√©e</option>
        <option value="Cancelled">Annul√©e</option>
      </select>
      <input type="date" class="form-control" style="width:auto" [(ngModel)]="dateFrom" (change)="loadOrders()" />
      <input type="date" class="form-control" style="width:auto" [(ngModel)]="dateTo" (change)="loadOrders()" />
    </div>
  </div>

  @if (loading()) {
    <app-loading />
  } @else if (orders().length === 0) {
    <app-empty-state icon="bi-receipt" message="Aucune commande trouv√©e" />
  } @else {

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    @if (viewMode === 'list') {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>N¬∞ Commande</th><th>Type</th><th>Client</th><th>Prestataire</th><th>Livreur</th>
              <th>Montant</th><th>Commission</th><th>Paiement</th><th>Statut</th><th>Date</th><th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (o of orders(); track o.id) {
              <tr>
                <td><span class="fw-medium text-primary">#{{ o.orderNumber }}</span></td>
                <td>
                  @switch (o.orderType) {
                    @case ('Restaurant') { <span class="badge bg-warning-subtle text-warning">üçî Restaurant</span> }
                    @case ('Service') { <span class="badge bg-info-subtle text-info">üõ†Ô∏è Service</span> }
                    @case ('Grocery') { <span class="badge bg-success-subtle text-success">üõí Courses</span> }
                  }
                </td>
                <td>{{ o.customerName }}</td>
                <td>{{ o.providerName }}</td>
                <td>{{ o.delivererName || '-' }}</td>
                <td class="fw-bold">{{ o.totalAmount | number:'1.2-2' }} MAD</td>
                <td class="text-muted">{{ o.commissionAmount | number:'1.2-2' }}</td>
                <td>
                  @if (o.paymentStatus === 'Paid') {
                    <span class="badge bg-success-subtle text-success">Pay√©</span>
                  } @else if (o.paymentStatus === 'Refunded') {
                    <span class="badge bg-info-subtle text-info">Rembours√©</span>
                  } @else {
                    <span class="badge bg-warning-subtle text-warning">En attente</span>
                  }
                </td>
                <td>
                  @let s = (o.status | statusBadge);
                  <span class="badge-status" [class]="'bg-' + s.color + '-subtle text-' + s.color">{{ s.label }}</span>
                </td>
                <td class="text-muted small">{{ o.createdAt | date:'dd/MM HH:mm' }}</td>
                <td class="text-end">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> D√©tails
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-person-badge text-secondary"></i> R√©assigner livreur
                        </a>
                      </li>
                      @if (o.paymentStatus === 'Paid' && o.status !== 'Refunded') {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-info" (click)="refundOrder(o)" style="cursor:pointer">
                            <i class="bi bi-arrow-counterclockwise"></i> Rembourser
                          </a>
                        </li>
                      }
                      @if (o.status !== 'Cancelled' && o.status !== 'Delivered') {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-danger" (click)="cancelOrder(o)" style="cursor:pointer">
                            <i class="bi bi-x-circle"></i> Annuler
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARD VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    @if (viewMode === 'card') {
      <div class="row g-3 p-3">
        @for (o of orders(); track o.id) {
          <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm card-hover h-100" style="border-radius:12px">
              <div class="card-body p-3">
                <!-- Header -->
                <div class="d-flex align-items-start justify-content-between mb-2">
                  <span class="fw-bold text-primary">#{{ o.orderNumber }}</span>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> D√©tails
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-person-badge text-secondary"></i> R√©assigner livreur
                        </a>
                      </li>
                      @if (o.paymentStatus === 'Paid' && o.status !== 'Refunded') {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-info" (click)="refundOrder(o)" style="cursor:pointer">
                            <i class="bi bi-arrow-counterclockwise"></i> Rembourser
                          </a>
                        </li>
                      }
                      @if (o.status !== 'Cancelled' && o.status !== 'Delivered') {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-danger" (click)="cancelOrder(o)" style="cursor:pointer">
                            <i class="bi bi-x-circle"></i> Annuler
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                </div>

                <!-- Type + Status -->
                <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                  @switch (o.orderType) {
                    @case ('Restaurant') { <span class="badge bg-warning-subtle text-warning">üçî Restaurant</span> }
                    @case ('Service') { <span class="badge bg-info-subtle text-info">üõ†Ô∏è Service</span> }
                    @case ('Grocery') { <span class="badge bg-success-subtle text-success">üõí Courses</span> }
                  }
                  @let s = (o.status | statusBadge);
                  <span class="badge" [class]="'bg-' + s.color + '-subtle text-' + s.color">{{ s.label }}</span>
                </div>

                <!-- Info -->
                <div class="mb-2">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="bi bi-person text-muted" style="font-size:0.8rem"></i>
                    <small>{{ o.customerName }}</small>
                  </div>
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="bi bi-shop text-muted" style="font-size:0.8rem"></i>
                    <small>{{ o.providerName }}</small>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-truck text-muted" style="font-size:0.8rem"></i>
                    <small>{{ o.delivererName || 'Non assign√©' }}</small>
                  </div>
                </div>

                <!-- Amount + Payment -->
                <div class="d-flex justify-content-between align-items-center pt-2 border-top mt-2">
                  <div>
                    <div class="fw-bold" style="font-size:1rem">{{ o.totalAmount | number:'1.2-2' }} MAD</div>
                    <small class="text-muted">Comm. {{ o.commissionAmount | number:'1.2-2' }}</small>
                  </div>
                  @if (o.paymentStatus === 'Paid') {
                    <span class="badge bg-success-subtle text-success rounded-pill"><i class="bi bi-check-circle me-1"></i>Pay√©</span>
                  } @else if (o.paymentStatus === 'Refunded') {
                    <span class="badge bg-info-subtle text-info rounded-pill">Rembours√©</span>
                  } @else {
                    <span class="badge bg-warning-subtle text-warning rounded-pill">En attente</span>
                  }
                </div>

                <!-- Date -->
                <div class="text-muted text-end mt-2" style="font-size:0.72rem">
                  <i class="bi bi-clock me-1"></i>{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <div class="p-3 border-top">
      <app-pagination [currentPage]="page()" [totalPages]="totalPages()" (pageChange)="goToPage($event)" />
    </div>
  }
</div>

<app-confirm-modal [show]="showConfirm()" [title]="confirmTitle()" [message]="confirmMessage()"
  [confirmText]="confirmText()" (confirmed)="onConfirm()" (cancelled)="onCancel()" />