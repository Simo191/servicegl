<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h4 class="fw-bold mb-1">Gestion des Livreurs</h4>
    <p class="text-muted mb-0">{{ deliverers().length }} livreurs enregistr√©s</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <div class="btn-group btn-group-sm" role="group">
      <button class="btn" [class]="viewMode === 'list' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'list'" title="Vue liste">
        <i class="bi bi-list-ul"></i>
      </button>
      <button class="btn" [class]="viewMode === 'card' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'card'" title="Vue cartes">
        <i class="bi bi-grid-3x3-gap"></i>
      </button>
    </div>
  </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-icon mb-2" style="background:#ecfdf5"><i class="bi bi-circle-fill" style="color:#10b981;font-size:0.7rem"></i></div>
      <h4 class="fw-bold mb-0">{{ onlineCount() }}</h4>
      <small class="text-muted">En ligne</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-icon mb-2" style="background:#fef2f2"><i class="bi bi-circle-fill" style="color:#ef4444;font-size:0.7rem"></i></div>
      <h4 class="fw-bold mb-0">{{ offlineCount() }}</h4>
      <small class="text-muted">Hors ligne</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-icon mb-2" style="background:#fef3c7"><i class="bi bi-clock" style="color:#f59e0b"></i></div>
      <h4 class="fw-bold mb-0">{{ pendingCount() }}</h4>
      <small class="text-muted">En attente</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-icon mb-2" style="background:#eef2ff"><i class="bi bi-truck" style="color:#4f46e5"></i></div>
      <h4 class="fw-bold mb-0">{{ totalDeliveries() | number }}</h4>
      <small class="text-muted">Livraisons totales</small>
    </div>
  </div>
</div>

<div class="table-card">
  <div class="card-header">
    <div class="d-flex gap-2">
      <div class="input-group" style="max-width:260px">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Rechercher..." [(ngModel)]="search" />
      </div>
      <select class="form-select" style="width:auto" [(ngModel)]="statusFilter">
        <option value="">Tous</option>
        <option value="online">En ligne</option>
        <option value="offline">Hors ligne</option>
        <option value="pending">En attente</option>
      </select>
      <select class="form-select" style="width:auto" [(ngModel)]="vehicleFilter">
        <option value="">Tous v√©hicules</option>
        <option value="Moto">Moto</option>
        <option value="Voiture">Voiture</option>
        <option value="Velo">V√©lo</option>
        <option value="Scooter">Scooter</option>
      </select>
    </div>
  </div>

  @if (loading()) {
    <app-loading />
  } @else if (filteredDeliverers().length === 0) {
    <app-empty-state icon="bi-truck" message="Aucun livreur trouv√©" />
  } @else {

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    @if (viewMode === 'list') {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr><th>Livreur</th><th>V√©hicule</th><th>Statut</th><th>Note</th><th>Livraisons</th><th>Gains</th><th>V√©rification</th><th class="text-end">Actions</th></tr>
          </thead>
          <tbody>
            @for (d of paginatedDeliverers(); track d.id) {
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="position-relative">
                      <div class="avatar-circle">{{ d.firstName[0] }}{{ d.lastName[0] }}</div>
                      @if (d.isOnline) {
                        <span class="online-dot"></span>
                      }
                    </div>
                    <div>
                      <div class="fw-medium">{{ d.firstName }} {{ d.lastName }}</div>
                      <small class="text-muted">{{ d.phone }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-light text-dark">
                    @switch (d.vehicleType) {
                      @case ('Moto') { üèçÔ∏è }
                      @case ('Voiture') { üöó }
                      @case ('Velo') { üö≤ }
                      @case ('Scooter') { üõµ }
                    }
                    {{ d.vehicleType }}
                  </span>
                </td>
                <td>
                  @if (d.isOnline) {
                    <span class="badge-status badge-success">En ligne</span>
                  } @else {
                    <span class="badge-status" style="background:#f1f5f9;color:#64748b">Hors ligne</span>
                  }
                </td>
                <td><span class="text-warning">‚òÖ</span> {{ d.rating.toFixed(1) }}</td>
                <td>{{ d.totalDeliveries | number }}</td>
                <td class="fw-medium">{{ d.totalEarnings | number:'1.0-0' }} MAD</td>
                <td>
                  @if (d.isVerified) {
                    <span class="badge bg-success-subtle text-success"><i class="bi bi-check-circle me-1"></i>V√©rifi√©</span>
                  } @else {
                    <span class="badge bg-warning-subtle text-warning"><i class="bi bi-clock me-1"></i>En attente</span>
                  }
                </td>
                <td class="text-end">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> Voir le profil
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-geo-alt text-info"></i> Localiser
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-bar-chart text-secondary"></i> Statistiques
                        </a>
                      </li>
                      @if (!d.isVerified) {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-success" (click)="approve(d.id)" style="cursor:pointer">
                            <i class="bi bi-check-circle"></i> Approuver
                          </a>
                        </li>
                      }
                      @if (d.isVerified) {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-danger" style="cursor:pointer">
                            <i class="bi bi-pause-circle"></i> Suspendre
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARD VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    @if (viewMode === 'card') {
      <div class="row g-3 p-3">
        @for (d of paginatedDeliverers(); track d.id) {
          <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm card-hover h-100" style="border-radius:12px">
              <div class="card-body p-3">
                <!-- Header -->
                <div class="d-flex align-items-start justify-content-between mb-3">
                  <div class="d-flex align-items-center gap-2">
                    <div class="position-relative">
                      <div class="avatar-circle avatar-circle-lg">{{ d.firstName[0] }}{{ d.lastName[0] }}</div>
                      @if (d.isOnline) {
                        <span class="online-dot"></span>
                      }
                    </div>
                    <div>
                      <h6 class="fw-bold mb-0">{{ d.firstName }} {{ d.lastName }}</h6>
                      <small class="text-muted">{{ d.phone }}</small>
                    </div>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> Voir le profil
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-geo-alt text-info"></i> Localiser
                        </a>
                      </li>
                      @if (!d.isVerified) {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-success" (click)="approve(d.id)" style="cursor:pointer">
                            <i class="bi bi-check-circle"></i> Approuver
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                </div>

                <!-- Badges -->
                <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
                  <span class="badge bg-light text-dark">
                    @switch (d.vehicleType) {
                      @case ('Moto') { üèçÔ∏è }
                      @case ('Voiture') { üöó }
                      @case ('Velo') { üö≤ }
                      @case ('Scooter') { üõµ }
                    }
                    {{ d.vehicleType }}
                  </span>
                  @if (d.isOnline) {
                    <span class="badge bg-success-subtle text-success rounded-pill" style="font-size:0.7rem">
                      <i class="bi bi-circle-fill me-1" style="font-size:0.4rem;vertical-align:middle"></i>En ligne
                    </span>
                  } @else {
                    <span class="badge bg-secondary-subtle text-secondary rounded-pill" style="font-size:0.7rem">Hors ligne</span>
                  }
                  @if (d.isVerified) {
                    <span class="badge bg-success-subtle text-success rounded-pill" style="font-size:0.7rem"><i class="bi bi-patch-check-fill me-1"></i>V√©rifi√©</span>
                  }
                </div>

                <!-- Stats -->
                <div class="row g-2 text-center">
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem"><span class="text-warning">‚òÖ</span> {{ d.rating.toFixed(1) }}</div>
                      <div class="text-muted" style="font-size:0.68rem">Note</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem">{{ d.totalDeliveries | number }}</div>
                      <div class="text-muted" style="font-size:0.68rem">Courses</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem">{{ d.totalEarnings | number:'1.0-0' }}</div>
                      <div class="text-muted" style="font-size:0.68rem">MAD</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Pagination -->
    <div class="d-flex align-items-center justify-content-between p-3 border-top">
      <small class="text-muted">
        Affichage de {{ paginatedDeliverers().length }} sur {{ filteredDeliverers().length }} livreurs
      </small>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="currentPage = currentPage - 1" style="cursor:pointer"><i class="bi bi-chevron-left"></i></a>
          </li>
          @for (p of pages(); track p) {
            <li class="page-item" [class.active]="p === currentPage">
              <a class="page-link" (click)="currentPage = p" style="cursor:pointer">{{ p }}</a>
            </li>
          }
          <li class="page-item" [class.disabled]="currentPage === totalPagesCalc()">
            <a class="page-link" (click)="currentPage = currentPage + 1" style="cursor:pointer"><i class="bi bi-chevron-right"></i></a>
          </li>
        </ul>
      </nav>
    </div>
  }
</div>

<app-confirm-modal [show]="showConfirm()" [title]="confirmTitle()" [message]="confirmMessage()"
  [confirmText]="confirmText()" (confirmed)="onConfirm()" (cancelled)="onCancel()" />