<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h4 class="fw-bold mb-1">Magasins / Courses en ligne</h4>
    <p class="text-muted mb-0">{{ stores().length }} magasins partenaires</p>
  </div>
  <div class="d-flex align-items-center gap-2">
    <div class="btn-group btn-group-sm" role="group">
      <button class="btn" [class]="viewMode === 'list' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'list'" title="Vue liste">
        <i class="bi bi-list-ul"></i>
      </button>
      <button class="btn" [class]="viewMode === 'card' ? 'btn-primary' : 'btn-outline-secondary'" (click)="viewMode = 'card'" title="Vue cartes">
        <i class="bi bi-grid-3x3-gap"></i>
      </button>
    </div>
  </div>
</div>

<!-- Brands -->
<div class="row g-3 mb-4">
  @for (brand of brands; track brand.name) {
    <div class="col-md col-6">
      <div class="stat-card text-center" style="cursor:pointer" [class.border-primary]="selectedBrand === brand.name"
           (click)="filterByBrand(brand.name)">
        <i class="bi bi-building fs-3" [style.color]="brand.color"></i>
        <h6 class="fw-bold mt-2 mb-0">{{ brand.name }}</h6>
        <small class="text-muted">{{ brand.count }} magasins</small>
      </div>
    </div>
  }
</div>

<div class="table-card">
  <div class="card-header">
    <h6 class="fw-bold mb-0">Liste des magasins</h6>
    <div class="input-group" style="max-width:250px">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" placeholder="Rechercher..." [(ngModel)]="search" (input)="onSearch()" />
    </div>
  </div>

  @if (loading()) {
    <app-loading />
  } @else if (filteredStores().length === 0) {
    <app-empty-state icon="bi-cart3" message="Aucun magasin trouvé" />
  } @else {

    <!-- ═══════ LIST VIEW ═══════ -->
    @if (viewMode === 'list') {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Magasin</th><th>Enseigne</th><th>Ville</th><th>Produits</th>
              <th>Commandes</th><th>CA</th><th>Commission</th><th>Statut</th><th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (s of paginatedStores(); track s.id) {
              <tr>
                <td class="fw-medium">{{ s.name }}</td>
                <td><span class="badge bg-success-subtle text-success">{{ s.brand }}</span></td>
                <td>{{ s.city }}</td>
                <td>{{ s.totalProducts | number }}</td>
                <td>{{ s.totalOrders | number }}</td>
                <td class="fw-medium">{{ s.totalRevenue | number:'1.0-0' }} MAD</td>
                <td>{{ s.commissionRate }}%</td>
                <td>
                  @if (s.isActive) {
                    <span class="badge-status badge-success">Actif</span>
                  } @else {
                    <span class="badge-status badge-danger">Inactif</span>
                  }
                </td>
                <td class="text-end">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> Voir les détails
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-pencil-square text-secondary"></i> Modifier
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-box-seam text-info"></i> Gérer les produits
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-bar-chart text-success"></i> Statistiques
                        </a>
                      </li>
                      @if (!s.isActive) {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item d-flex align-items-center gap-2 text-success" (click)="approveStore(s.id)" style="cursor:pointer">
                            <i class="bi bi-check-circle"></i> Activer
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- ═══════ CARD VIEW ═══════ -->
    @if (viewMode === 'card') {
      <div class="row g-3 p-3">
        @for (s of paginatedStores(); track s.id) {
          <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm card-hover h-100" style="border-radius:12px">
              <div class="card-body p-3">
                <!-- Header -->
                <div class="d-flex align-items-start justify-content-between mb-3">
                  <div class="d-flex align-items-center gap-2">
                    <div class="avatar-icon bg-success-subtle text-success">
                      <i class="bi bi-cart3"></i>
                    </div>
                    <div>
                      <h6 class="fw-bold mb-0 text-truncate" style="max-width:130px">{{ s.name }}</h6>
                      <span class="badge bg-success-subtle text-success" style="font-size:0.68rem">{{ s.brand }}</span>
                    </div>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border-0 rounded-circle action-dots" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-eye text-primary"></i> Voir les détails
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-pencil-square text-secondary"></i> Modifier
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" style="cursor:pointer">
                          <i class="bi bi-box-seam text-info"></i> Gérer les produits
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

                <!-- Badges -->
                <div class="d-flex align-items-center gap-2 mb-3">
                  <span class="badge bg-light text-muted"><i class="bi bi-geo-alt me-1"></i>{{ s.city }}</span>
                  @if (s.isActive) {
                    <span class="badge bg-success-subtle text-success rounded-pill" style="font-size:0.7rem">
                      <i class="bi bi-circle-fill me-1" style="font-size:0.4rem;vertical-align:middle"></i>Actif
                    </span>
                  } @else {
                    <span class="badge bg-danger-subtle text-danger rounded-pill" style="font-size:0.7rem">Inactif</span>
                  }
                </div>

                <!-- Stats -->
                <div class="row g-2 text-center">
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem">{{ s.totalProducts | number }}</div>
                      <div class="text-muted" style="font-size:0.68rem">Produits</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem">{{ s.totalOrders | number }}</div>
                      <div class="text-muted" style="font-size:0.68rem">Commandes</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="bg-light rounded-3 p-2">
                      <div class="fw-bold" style="font-size:0.9rem">{{ s.commissionRate }}%</div>
                      <div class="text-muted" style="font-size:0.68rem">Comm.</div>
                    </div>
                  </div>
                </div>

                <!-- Revenue -->
                <div class="mt-3 pt-2 border-top">
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Chiffre d'affaires</small>
                    <span class="fw-bold" style="font-size:0.88rem">{{ s.totalRevenue | number:'1.0-0' }} MAD</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Pagination -->
    <div class="d-flex align-items-center justify-content-between p-3 border-top">
      <small class="text-muted">
        Affichage de {{ paginatedStores().length }} sur {{ filteredStores().length }} magasins
      </small>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="currentPage = currentPage - 1" style="cursor:pointer"><i class="bi bi-chevron-left"></i></a>
          </li>
          @for (p of pages(); track p) {
            <li class="page-item" [class.active]="p === currentPage">
              <a class="page-link" (click)="currentPage = p" style="cursor:pointer">{{ p }}</a>
            </li>
          }
          <li class="page-item" [class.disabled]="currentPage === totalPagesCalc()">
            <a class="page-link" (click)="currentPage = currentPage + 1" style="cursor:pointer"><i class="bi bi-chevron-right"></i></a>
          </li>
        </ul>
      </nav>
    </div>
  }
</div>

<app-confirm-modal [show]="showConfirm()" [title]="confirmTitle()" [message]="confirmMessage()"
  [confirmText]="confirmText()" (confirmed)="onConfirm()" (cancelled)="onCancel()" />