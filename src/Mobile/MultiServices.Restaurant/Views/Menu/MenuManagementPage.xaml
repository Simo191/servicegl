<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MultiServices.Restaurant.ViewModels" xmlns:models="clr-namespace:MultiServices.Restaurant.Models"
             x:Class="MultiServices.Restaurant.Views.Menu.MenuManagementPage" x:DataType="vm:MenuManagementViewModel" Title="Menu">
    <Grid RowDefinitions="Auto,*">
        <HorizontalStackLayout Padding="16,8" Spacing="8">
            <Button Text="+ Catégorie" Command="{Binding AddCategoryCommand}" BackgroundColor="{StaticResource Primary}" TextColor="White" CornerRadius="8" HeightRequest="36" FontSize="13" />
            <Button Text="+ Plat" Command="{Binding AddItemCommand}" BackgroundColor="{StaticResource Accent}" TextColor="White" CornerRadius="8" HeightRequest="36" FontSize="13" />
        </HorizontalStackLayout>
        <Grid Grid.Row="1" ColumnDefinitions="200,*">
            <!-- Categories sidebar -->
            <CollectionView ItemsSource="{Binding Categories}" SelectionMode="Single" SelectedItem="{Binding SelectedCategory}" SelectionChangedCommand="{Binding SelectCategoryCommand}" SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}" BackgroundColor="#FAFAFA">
                <CollectionView.ItemTemplate><DataTemplate x:DataType="models:MenuCategoryDto">
                    <Frame Padding="12,10" HasShadow="False" BackgroundColor="Transparent" CornerRadius="0" BorderColor="Transparent">
                        <VerticalStackLayout>
                            <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="14" />
                            <Label Text="{Binding Items.Count, StringFormat='{0} plats'}" FontSize="11" TextColor="{StaticResource TextMuted}" />
                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate></CollectionView.ItemTemplate>
            </CollectionView>
            <!-- Items list -->
            <CollectionView Grid.Column="1" ItemsSource="{Binding Items}" Margin="8,0">
                <CollectionView.ItemTemplate><DataTemplate x:DataType="models:MenuItemDto">
                    <SwipeView><SwipeView.RightItems><SwipeItems>
                        <SwipeItem Text="Supprimer" BackgroundColor="{StaticResource Danger}" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MenuManagementViewModel}}, Path=DeleteItemCommand}" CommandParameter="{Binding .}" />
                    </SwipeItems></SwipeView.RightItems>
                    <Frame Style="{StaticResource Card}" Margin="0,0,0,6" Padding="12">
                        <Grid ColumnDefinitions="60,*,Auto,Auto" ColumnSpacing="12">
                            <Frame CornerRadius="8" WidthRequest="60" HeightRequest="60" Padding="0" HasShadow="False" BackgroundColor="#F0F0F0" IsClippedToBounds="True">
                                <Image Source="{Binding ImageUrl}" Aspect="AspectFill" />
                            </Frame>
                            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="15" />
                                <Label Text="{Binding Description}" FontSize="12" TextColor="{StaticResource TextMuted}" LineBreakMode="TailTruncation" MaxLines="1" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding BasePrice, StringFormat='{0:N2} MAD'}" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Primary}" />
                                    <Frame BackgroundColor="#FFF3E0" CornerRadius="4" Padding="4,1" HasShadow="False" IsVisible="{Binding IsPopular}"><Label Text="★ Populaire" FontSize="10" TextColor="{StaticResource Warning}" /></Frame>
                                </HorizontalStackLayout>
                                <Label Text="{Binding Allergens, Converter={x:Null}}" FontSize="10" TextColor="{StaticResource Danger}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="2" IsToggled="{Binding IsAvailable}" VerticalOptions="Center" />
                            <Button Grid.Column="3" Text="✏️" BackgroundColor="Transparent" TextColor="{StaticResource Info}" WidthRequest="40" HeightRequest="40" Padding="0"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MenuManagementViewModel}}, Path=EditItemCommand}" CommandParameter="{Binding .}" />
                        </Grid>
                    </Frame></SwipeView>
                </DataTemplate></CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>
</ContentPage>