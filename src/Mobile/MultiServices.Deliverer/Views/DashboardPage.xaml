<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MultiServices.Deliverer.ViewModels"
             x:Class="MultiServices.Deliverer.Views.DashboardPage"
             x:DataType="vm:DashboardViewModel"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{StaticResource Background}">
    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Spacing="12" Padding="16">
                <!-- Header -->
                <Grid ColumnDefinitions="*,Auto" Padding="0,8">
                    <VerticalStackLayout>
                        <Label Text="{Binding DelivererName, StringFormat='Bonjour, {0} ðŸ‘‹'}" FontSize="20" FontAttributes="Bold" />
                        <Label Text="{Binding StatusText}" FontSize="14" TextColor="{Binding StatusColor}" />
                    </VerticalStackLayout>
                    <Button Grid.Column="1" Text="ðŸ†˜" Style="{StaticResource DangerButton}"
                            HeightRequest="44" WidthRequest="60" Command="{Binding SOSCommand}" />
                </Grid>

                <!-- Online Toggle -->
                <Frame Style="{StaticResource CardFrame}">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout>
                            <Label Text="Statut de connexion" FontAttributes="Bold" FontSize="16" />
                            <Label Text="{Binding IsOnline, Converter={x:StaticResource BoolToOnlineTextConverter}}"
                                   FontSize="13" TextColor="{StaticResource TextSecondary}" />
                        </VerticalStackLayout>
                        <Switch Grid.Column="1" IsToggled="{Binding IsOnline, Mode=OneWay}"
                                OnColor="{StaticResource Primary}"
                                Toggled="OnToggled" x:Name="OnlineSwitch" />
                    </Grid>
                </Frame>

                <!-- Today Stats -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <Frame Style="{StaticResource StatCard}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label Text="ðŸ’°" FontSize="28" HorizontalOptions="Center" />
                            <Label Text="{Binding TodayEarnings, StringFormat='{0:F2} MAD'}" FontSize="18"
                                   FontAttributes="Bold" HorizontalOptions="Center" />
                            <Label Text="Gains aujourd'hui" FontSize="12" TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Grid.Column="1" Style="{StaticResource StatCard}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label Text="ðŸ“¦" FontSize="28" HorizontalOptions="Center" />
                            <Label Text="{Binding TodayDeliveries}" FontSize="18"
                                   FontAttributes="Bold" HorizontalOptions="Center" />
                            <Label Text="Livraisons" FontSize="12" TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <Frame Style="{StaticResource StatCard}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label Text="â­" FontSize="28" HorizontalOptions="Center" />
                            <Label Text="{Binding AverageRating, StringFormat='{0:F1}'}" FontSize="18"
                                   FontAttributes="Bold" HorizontalOptions="Center" />
                            <Label Text="Note moyenne" FontSize="12" TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Grid.Column="1" Style="{StaticResource StatCard}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label Text="âœ…" FontSize="28" HorizontalOptions="Center" />
                            <Label Text="{Binding AcceptanceRate, StringFormat='{0:F0}%'}" FontSize="18"
                                   FontAttributes="Bold" HorizontalOptions="Center" />
                            <Label Text="Taux acceptation" FontSize="12" TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- Active Delivery Banner -->
                <Frame Style="{StaticResource CardFrame}" BackgroundColor="#E8F5E9"
                       IsVisible="{Binding HasActiveDelivery}" Padding="16">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout>
                            <Label Text="ðŸš€ Livraison en cours" FontAttributes="Bold" FontSize="16" TextColor="#2E7D32" />
                            <Label Text="{Binding ActiveDelivery.StatusLabel}" FontSize="14" TextColor="#388E3C" />
                        </VerticalStackLayout>
                        <Button Grid.Column="1" Text="Voir" BackgroundColor="#2E7D32" TextColor="White"
                                CornerRadius="8" HeightRequest="40" Command="{Binding GoToActiveDeliveryCommand}" />
                    </Grid>
                    <Frame.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToActiveDeliveryCommand}" />
                    </Frame.GestureRecognizers>
                </Frame>

                <!-- Active Bonuses -->
                <VerticalStackLayout IsVisible="{Binding ActiveBonuses.Count, Converter={x:StaticResource IntToBoolConverter}}">
                    <Label Text="ðŸ”¥ Bonus actifs" Style="{StaticResource SectionTitle}" />
                    <CollectionView ItemsSource="{Binding ActiveBonuses}" HeightRequest="100">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="x:Object">
                                <Frame BackgroundColor="#FFF3E0" CornerRadius="12" Padding="12" WidthRequest="200">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="14" />
                                        <Label Text="{Binding Description}" FontSize="12" TextColor="{StaticResource TextSecondary}" />
                                        <ProgressBar Progress="{Binding ProgressPercent, Converter={x:StaticResource PercentToDoubleConverter}}"
                                                     ProgressColor="{StaticResource Accent}" />
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Available Deliveries -->
                <Label Text="ðŸ“‹ Livraisons disponibles" Style="{StaticResource SectionTitle}" />

                <VerticalStackLayout IsVisible="{Binding IsOnline, Converter={x:StaticResource InvertBoolConverter}}">
                    <Frame Style="{StaticResource CardFrame}" Padding="24">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="8">
                            <Label Text="ðŸ“´" FontSize="40" HorizontalOptions="Center" />
                            <Label Text="Passez en ligne pour voir les livraisons" FontSize="15"
                                   HorizontalOptions="Center" TextColor="{StaticResource TextSecondary}" />
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>

                <CollectionView ItemsSource="{Binding AvailableDeliveries}"
                                IsVisible="{Binding IsOnline}">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="24" HorizontalOptions="Center">
                            <Label Text="Aucune livraison disponible pour le moment" FontSize="15"
                                   TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="x:Object">
                            <Frame Style="{StaticResource CardFrame}" Margin="0,4">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <Label Text="{Binding OrderTypeIcon}" FontSize="24" VerticalOptions="Center" />
                                        <VerticalStackLayout Grid.Column="1" Margin="8,0">
                                            <Label Text="{Binding PickupName}" FontAttributes="Bold" FontSize="15" />
                                            <Label Text="{Binding PickupAddress}" FontSize="12" TextColor="{StaticResource TextSecondary}" LineBreakMode="TailTruncation" />
                                        </VerticalStackLayout>
                                        <Label Grid.Column="2" Text="{Binding EarningDisplay}" FontAttributes="Bold"
                                               FontSize="16" TextColor="{StaticResource Primary}" VerticalOptions="Center" />
                                    </Grid>
                                    <BoxView HeightRequest="1" Color="#E0E0E0" />
                                    <Grid ColumnDefinitions="*,*,*">
                                        <HorizontalStackLayout Spacing="4" HorizontalOptions="Center">
                                            <Label Text="ðŸ“" FontSize="14" />
                                            <Label Text="{Binding DistanceDisplay}" FontSize="13" />
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="1" Spacing="4" HorizontalOptions="Center">
                                            <Label Text="â±" FontSize="14" />
                                            <Label Text="{Binding TimeDisplay}" FontSize="13" />
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="2" Spacing="4" HorizontalOptions="Center">
                                            <Label Text="ðŸ“¦" FontSize="14" />
                                            <Label Text="{Binding ItemCount, StringFormat='{0} articles'}" FontSize="13" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                        <Button Text="Refuser" Style="{StaticResource SecondaryButton}" HeightRequest="40" FontSize="14"
                                                Command="{Binding Source={x:Reference This}, Path=BindingContext.RejectDeliveryCommand}"
                                                CommandParameter="{Binding .}" />
                                        <Button Grid.Column="1" Text="Accepter âœ“" Style="{StaticResource PrimaryButton}" HeightRequest="40" FontSize="14"
                                                Command="{Binding Source={x:Reference This}, Path=BindingContext.AcceptDeliveryCommand}"
                                                CommandParameter="{Binding .}" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" Color="{StaticResource Primary}" />
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>